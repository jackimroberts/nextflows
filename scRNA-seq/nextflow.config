params {
    cellRanger_transcriptome = "/uufs/chpc.utah.edu/common/home/hcibcore/atlatl/data/Mouse/GRCm39/10x_star/refdata-gex-GRCm39-2024-A"
}

process {
    executor       = 'slurm'
    clusterOptions  = "--partition=kingspeak-shared --qos=kingspeak --account=vetter -o slurmjob-%j.out-%N -e slurmjob-%j.err-%N"
    maxRetries     = 1
    errorStrategy  = { task.attempt <= 3 ? 'retry' : 'finish' }
    cache          = 'lenient'
    beforeScript = 'module load singularity'
    
    memory = 8.GB  // Default memory for all processes
    cpus = 2       // Default CPUs for all processes
    
    resourceLimits = [memory: 250.GB]
    
    // Process-specific memory allocation
    withName: run_cellranger {
        memory = { 32.GB + ((task.attempt - 1) * 16.GB) }
        cpus = 8
    }
    
    withName: seurat_markdown {
        memory = { 16.GB + ((task.attempt - 1) * 16.GB) }
        cpus = 8
    }
    
    withName: run_velocyto {
        memory = { 16.GB + ((task.attempt - 1) * 8.GB) }
        cpus = 8
    }
    
    withName: decompress {
        memory = { 16.GB + ((task.attempt - 1) * 8.GB) }
        cpus = 4
    }
    
    withName: get_fastq {
        memory = { 16.GB + ((task.attempt - 1) * 8.GB) }
        cpus = 8
        clusterOptions = "--ntasks=8"
    }

    // Run minimal processes locally
    withName: 'make_sample_table' {
        executor       = 'local'
        memory = 1.GB
        cpus = 1
    }

}
